<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üí≥ Universal Card Data Extractor</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 15px;
      background: #f5f7fa;
      color: #1a1a1a;
    }
    h1 { text-align: center; color: #2c3e50; font-size: 1.4em; }
    .desc { text-align: center; color: #555; font-size: 14px; }
    .upload-area {
      text-align: center;
      padding: 30px;
      border: 2px dashed #3498db;
      border-radius: 10px;
      background: white;
      margin: 20px 0;
    }
    input[type="file"] { margin: 10px 0; font-size: 16px; }
    button {
      padding: 10px 20px;
      background: #2980b9;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover { background: #1a6ba0; }
    #output {
      margin-top: 20px;
    }
    table {
      width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px;
      background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; white-space: nowrap; }
    th { background-color: #2980b9; color: white; }
    tr:nth-child(even) { background-color: #f8f9fa; }
    .loading { text-align: center; color: #7f8c8d; padding: 15px; }
    .actions { text-align: center; margin: 20px 0; }
  </style>
</head>
<body>

  <h1>üí≥ Universal Card Data Extractor</h1>
  <p class="desc">Upload Cc.pdf, Cardslist.txt, or Extracted table.pdf</p>

  <div class="upload-area">
    <input type="file" id="fileInput" accept=".txt,.pdf" />
    <br>
    <button id="parseBtn" disabled>üîß Extract and Add to Table</button>
    <button id="clearBtn">üóëÔ∏è Clear All Data</button>
  </div>

  <div class="actions">
    <button id="downloadBtn">üì• Download Table (CSV)</button>
  </div>

  <div class="loading" id="status">Loading saved data...</div>
  <div id="output"></div>

  <script>
    const fileInput = document.getElementById('fileInput');
    const parseBtn = document.getElementById('parseBtn');
    const clearBtn = document.getElementById('clearBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const status = document.getElementById('status');
    const output = document.getElementById('output');

    // Load saved data
    let allResults = JSON.parse(localStorage.getItem('cardData_v3')) || [];

    function saveData() {
      localStorage.setItem('cardData_v3', JSON.stringify(allResults));
    }

    function renderTable() {
      if (allResults.length === 0) {
        output.innerHTML = '<p>No data yet. Upload a file to get started.</p>';
        status.textContent = '‚úÖ No saved data.';
        return;
      }

      let tableHTML = `<table><thead><tr>
        <th>Card Number</th><th>Exp. Date</th><th>CVV</th><th>Name</th>
        <th>Address</th><th>City</th><th>State</th><th>ZIP</th><th>Bank Name</th>
      </tr></thead><tbody>`;

      allResults.forEach(row => {
        tableHTML += `<tr>
          <td>${row['Card Number']}</td>
          <td>${row['Exp. Date']}</td>
          <td>${row['CVV']}</td>
          <td>${row['Name']}</td>
          <td title="${row['Address']}">${row['Address'].length > 30 ? row['Address'].substring(0,30)+'...' : row['Address']}</td>
          <td>${row['City']}</td>
          <td>${row['State']}</td>
          <td>${row['ZIP']}</td>
          <td>${row['Bank Name']}</td>
        </tr>`;
      });

      tableHTML += `</tbody></table>`;
      output.innerHTML = tableHTML;
      status.textContent = `‚úÖ ${allResults.length} entries loaded.`;
    }

    fileInput.addEventListener('change', () => {
      parseBtn.disabled = !fileInput.files.length;
    });

    parseBtn.addEventListener('click', async () => {
      const file = fileInput.files[0];
      if (!file) return;

      status.textContent = 'Reading file...';
      parseBtn.disabled = true;

      try {
        let text = await file.text();

        // Normalize delimiters: \||I|l|1 ‚Üí |
        text = text
          .replace(/\\\\\\|/g, '|')
          .replace(/\\|/g, '|')
          .replace(/[Il1l\|~;]/g, '|')
          .replace(/\s*\|\s*/g, '|')
          .replace(/\s+/g, ' ')
          .trim();

        const lines = text.split('\n').filter(line => line.trim());
        const newEntries = [];

        const banks = [
          'Regions Bank', 'Navy F.C.U.', 'Gecu', 'Central Bank Of Kansas City',
          'Yellowstone Bank, The', 'Bancorp', 'Capital One Bank(Usa), National Association',
          'Fifth Third Bank, The', 'Bank Of America, N.A.', 'Usaa Savings Bank',
          'Jpmorgan Chase Bank, N.A.', 'Bbva Usa', 'Metabank', 'Woodforest National Bank',
          'Centra C.U.', 'Wells Fargo Bank, N.A.', 'Bank Of Missouri, The',
          'Synchrony Bank', 'Merrick Bank Corporation', 'Discover Bank', 'Golden 1 C.U.',
          'Plains Commerce Bank', 'First Bank And Trust Company', 'American Express Us',
          'Green Dot', 'Citibank N.A.', 'Pnc Bank, N.A.', 'Webbank'
        ];

        for (const line of lines) {
          const parts = line.split('|').map(p => p.trim()).filter(p => p);

          // Find card number (15‚Äì16 digits)
          const cardIndex = parts.findIndex(p => /^\d{15,16}$/.test(p));
          if (cardIndex === -1) continue;

          const cardNumber = parts[cardIndex];
          const expMonth = parts[cardIndex + 1]?.replace(/\D/g, '') || '';
          const expYear = parts[cardIndex + 2]?.replace(/\D/g, '') || '';
          const cvv = parts[cardIndex + 2] || '';
          let name = parts[cardIndex + 3] || 'Unknown';
          let address = parts[cardIndex + 4] || '';
          let city = parts[cardIndex + 5] || '';
          let state = parts[cardIndex + 6] || '';
          let zip = parts[cardIndex + 7] || '';

          // Fix "UNITED STATES" in name field
          if (name === 'UNITED STATES' || name === 'United States') {
            name = parts[cardIndex + 4] || 'Unknown';
            address = parts[cardIndex + 5] || '';
            city = parts[cardIndex + 6] || '';
            state = parts[cardIndex + 7] || '';
            zip = parts[cardIndex + 8] || '';
          }

          // Clean state
          state = state
            .replace(/Now Yor[\u043A<]/, 'New York')
            .replace(/Florid[\u0430–∞]/, 'Florida')
            .replace(/Texasl/, 'Texas')
            .replace(/\d+/, '')
            .trim();

          // Detect bank
          let bankName = 'Unknown';
          for (const bank of banks) {
            if (line.includes(bank)) {
              bankName = bank;
              break;
            }
          }

          // Fix common OCR issues in name
          name = name.replace(/UNITED STATES/g, '').trim() || 'Unknown';

          newEntries.push({
            "Card Number": cardNumber,
            "Exp. Date": expMonth && expYear ? `${expMonth}/${expYear.slice(-2)}` : '',
            "CVV": cvv,
            "Name": name,
            "Address": address,
            "City": city,
            "State": state,
            "ZIP": zip,
            "Bank Name": bankName
          });
        }

        // Merge: avoid duplicates
        const existingCards = new Set(allResults.map(r => r['Card Number']));
        const added = newEntries.filter(e => !existingCards.has(e['Card Number']));
        allResults.push(...added);

        saveData();
        renderTable();
        status.textContent = `‚úÖ Added ${added.length} new entries. Total: ${allResults.length}`;

      } catch (err) {
        status.textContent = `‚ùå Error: ${err.message}`;
        console.error(err);
      } finally {
        parseBtn.disabled = false;
      }
    });

    clearBtn.addEventListener('click', () => {
      if (confirm('Delete all saved data?')) {
        allResults = [];
        localStorage.removeItem('cardData_v3');
        output.innerHTML = '';
        status.textContent = 'üóëÔ∏è All data cleared.';
      }
    });

    downloadBtn.addEventListener('click', () => {
      if (allResults.length === 0) return;

      const headers = Object.keys(allResults[0]);
      const csv = [
        headers.join(','),
        ...allResults.map(row => headers.map(h => `"${(row[h] || '').replace(/"/g, '""')}"`).join(','))
      ].join('\n');

      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'card-data.csv';
      a.click();
      URL.revokeObjectURL(url);
    });

    // Initial render
    renderTable();
  </script>
</body>
</html>
